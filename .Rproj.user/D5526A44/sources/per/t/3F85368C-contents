# Data Cleaning

library(tidyverse)
library(lubridate)


airlines <- read_csv(here::here("raw_data/airlines.csv"))
airports <- read_csv(here::here("raw_data/airports.csv"))
flights <- read_csv(here::here("raw_data/flights.csv"))
planes <- read_csv(here::here("raw_data/planes.csv"))
weather <- read_csv(here::here("raw_data/weather.csv"))


#I will generally postpone the cleaning decisions after the joins operations. However, there are a few necessary actions that rised from the `data_exploration` file that I can handle right now.

#`weather` dataset

# From`Assumption 1` of the `data_exploration` file, I decided to delete from the `weather` dataset the columns `temp`, `dewp`,`pressure`,`precip` and `humid`, since the non NAs values here are only the 2% of the entire dataset, which make them not statistically significant.
#I am going to delete also the 'year' column, since all the data refers to the same year, i.e. 2017.

#The first think I need to do is joining the`flights` dataset with the one containing information about the `weather`. Before doing that we notice that in the two datasets appears columns with the same name, e.g. 'year', 'month', 'day' etc..., wich apparently refer to different things, actually I want that the coincide since I am interested in comparing weather and flights times, but I have this information also in the `time_hour` column which is used for the join, so I think that the best choice should be that of deleting them from both the datasets before joining.

weather <- weather %>% 
  select(-c("temp", "dewp", "pressure", "precip", "humid", "year", "month", "day", "hour"))



flights <- flights %>% 
  select(-c("month", "day", "hour", "year"))

flights_weather <- inner_join(flights, weather, by = c("time_hour", "origin"))


#Finally I am going to create separate columns for `year`, `month`, `day` and `hour`.

flights_weather <- flights_weather %>% 
  mutate(
    year = year(time_hour),
    month = month(time_hour),
    day = day(time_hour),
    hour = hour(time_hour)
  )


#In the following I am going to sobstitute the NAs in the weather parameters with a mean of their value for the same month, hour and day and drop all the NAs in those valus left. I will also drop the NAs in the 'dep_delay' column for now.

flights_weather <- flights_weather %>% 
  group_by(month, day, hour) %>%
  mutate(across(.col = c("wind_speed", "wind_gust", "wind_dir", "visib"), .fns = ~coalesce(.x, mean(.x, na.rm = TRUE)))) %>% 
  filter(!((is.na(wind_speed) | (is.na(wind_dir)) | (is.na(wind_gust)) | (is.na(visib)) | is.na(dep_delay))))

write_csv(flights_weather, "cleaned_data/flights_weather.csv")

















































